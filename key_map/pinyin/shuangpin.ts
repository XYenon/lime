import { getValue } from "../../utils/obj.ts";
import { spilt_pinyin } from "./split_pinyin.ts";

export type ShuangpinMap = {
	sm: Record<string, string>; // 声母映射
	ym: Record<string, string>; // 韵母映射
	raw: Record<string, string>;
};

export const shuangpinMaps = {
	自然码: {
		sm: { zh: "v", ch: "i", sh: "u" },
		ym: {
			iu: "q",
			ia: "w",
			ua: "w",
			e: "e",
			uan: "r",
			ue: "t",
			ve: "t",
			ing: "y",
			uai: "y",
			u: "u",
			i: "i",
			o: "o",
			uo: "o",
			un: "p",
			a: "a",
			iong: "s",
			ong: "s",
			iang: "d",
			uang: "d",
			en: "f",
			eng: "g",
			ang: "h",
			an: "j",
			ao: "k",
			ai: "l",
			ei: "z",
			ie: "x",
			iao: "c",
			ui: "v",
			v: "v",
			ou: "b",
			in: "n",
			ian: "m",
		},
		raw: {
			a: "aa",
			ai: "ai",
			an: "an",
			ang: "ah",
			ao: "ao",
			e: "ee",
			ei: "ei",
			en: "en",
			eng: "eg",
			er: "er",
			o: "oo",
			ou: "ou",
		},
	},

	搜狗: {
		sm: { ch: "i", sh: "u", zh: "v" },
		ym: {
			a: "a",
			ai: "l",
			an: "j",
			ang: "h",
			ao: "k",
			e: "e",
			ei: "z",
			en: "f",
			eng: "g",
			i: "i",
			ia: "w",
			ian: "m",
			iang: "d",
			iao: "c",
			ie: "x",
			iong: "s",
			in: "n",
			ing: ";",
			iu: "q",
			o: "o",
			ong: "s",
			ou: "b",
			u: "u",
			ua: "w",
			uai: "y",
			uan: "r",
			uang: "d",
			ue: "t",
			ui: "v",
			un: "p",
			uo: "o",
			v: "y",
			ve: "t",
		},
		raw: {
			a: "oa",
			ai: "ol",
			an: "oj",
			ang: "oh",
			ao: "ok",
			e: "oe",
			ei: "oz",
			en: "of",
			eng: "og",
			er: "or",
			o: "oo",
			ou: "ob",
		},
	},

	微软: {
		sm: { ch: "i", sh: "u", zh: "v" },
		ym: {
			a: "a",
			ai: "l",
			an: "j",
			ang: "h",
			ao: "k",
			e: "e",
			ei: "z",
			en: "f",
			eng: "g",
			i: "i",
			ia: "w",
			ian: "m",
			iang: "d",
			iao: "c",
			ie: "x",
			iong: "s",
			in: "n",
			ing: ";",
			iu: "q",
			o: "o",
			ong: "s",
			ou: "b",
			u: "u",
			ua: "w",
			uai: "y",
			uan: "r",
			uang: "d",
			ue: "t",
			ui: "v",
			un: "p",
			uo: "o",
			v: "y",
			ve: "v",
		},
		raw: {
			a: "oa",
			ai: "ol",
			an: "oj",
			ang: "oh",
			ao: "ok",
			e: "oe",
			ei: "oz",
			en: "of",
			eng: "og",
			er: "or",
			o: "oo",
			ou: "ob",
		},
	},

	小鹤: {
		sm: { ch: "i", sh: "u", zh: "v" },
		ym: {
			a: "a",
			ai: "d",
			an: "j",
			ang: "h",
			ao: "c",
			e: "e",
			ei: "w",
			en: "f",
			eng: "g",
			i: "i",
			ia: "x",
			ian: "m",
			iang: "l",
			iao: "n",
			ie: "p",
			iong: "s",
			in: "b",
			ing: "k",
			iu: "q",
			o: "o",
			ong: "s",
			ou: "z",
			u: "u",
			ua: "x",
			uai: "k",
			uan: "r",
			uang: "l",
			ue: "t",
			ui: "v",
			un: "y",
			uo: "o",
			v: "v",
			ve: "t",
		},
		raw: {
			a: "aa",
			ai: "ai",
			an: "an",
			ang: "ah",
			ao: "ao",
			e: "ee",
			ei: "ei",
			en: "en",
			eng: "eg",
			er: "er",
			o: "oo",
			ou: "ou",
		},
	},

	智能ABC: {
		sm: { ch: "e", sh: "v", zh: "a" },
		ym: {
			a: "a",
			ai: "l",
			an: "j",
			ang: "h",
			ao: "k",
			e: "e",
			ei: "q",
			en: "f",
			eng: "g",
			i: "i",
			ia: "d",
			ian: "w",
			iang: "t",
			iao: "z",
			ie: "x",
			iong: "s",
			in: "c",
			ing: "y",
			iu: "r",
			o: "o",
			ong: "s",
			ou: "b",
			u: "u",
			ua: "d",
			uai: "c",
			uan: "p",
			uang: "t",
			ue: "m",
			ui: "m",
			un: "n",
			uo: "o",
			v: "v",
			ve: "v",
		},
		raw: {
			a: "oa",
			ai: "ol",
			an: "oj",
			ang: "oh",
			ao: "ok",
			e: "oe",
			ei: "oq",
			en: "of",
			eng: "og",
			er: "or",
			o: "oo",
			ou: "ob",
		},
	},

	拼音加加: {
		sm: { ch: "u", sh: "i", zh: "v" },
		ym: {
			a: "a",
			ai: "s",
			an: "f",
			ang: "g",
			ao: "d",
			e: "e",
			ei: "w",
			en: "r",
			eng: "t",
			i: "i",
			ia: "b",
			ian: "j",
			iang: "h",
			iao: "k",
			ie: "m",
			iong: "y",
			in: "l",
			ing: "q",
			iu: "n",
			o: "o",
			ong: "y",
			ou: "p",
			u: "u",
			ua: "b",
			uai: "x",
			uan: "c",
			uang: "h",
			ue: "x",
			ui: "v",
			un: "z",
			uo: "o",
			v: "v",
			ve: "x",
		},
		raw: {
			a: "aa",
			ai: "as",
			an: "af",
			ang: "ag",
			ao: "ad",
			e: "ee",
			ei: "ew",
			en: "er",
			eng: "et",
			er: "eq",
			o: "oo",
			ou: "op",
		},
	},

	紫光: {
		sm: { ch: "a", sh: "i", zh: "u" },
		ym: {
			a: "a",
			ai: "p",
			an: "r",
			ang: "s",
			ao: "q",
			e: "e",
			ei: "k",
			en: "w",
			eng: "t",
			i: "i",
			ia: "x",
			ian: "f",
			iang: "g",
			iao: "b",
			ie: "d",
			iong: "h",
			in: "y",
			ing: ";",
			iu: "j",
			o: "o",
			ong: "h",
			ou: "z",
			u: "u",
			ua: "x",
			uai: "y",
			uan: "l",
			uang: "g",
			ue: "n",
			ui: "n",
			un: "m",
			uo: "o",
			v: "v",
			ve: "n",
		},
		raw: {
			a: "oa",
			ai: "op",
			an: "or",
			ang: "os",
			ao: "oq",
			e: "oe",
			ei: "ok",
			en: "ow",
			eng: "ot",
			er: "oj",
			o: "oo",
			ou: "oz",
		},
	},
} satisfies Record<string, ShuangpinMap>;

const cache = new Map<ShuangpinMap, Record<string, string[]>>();

export function generate_shuang_pinyin(
	pinyin_k_l: Array<string>,
	map: ShuangpinMap,
) {
	// biome-ignore lint/style/noNonNullAssertion: checked
	if (cache.has(map)) return cache.get(map)!;
	const { sm: sm_map, ym: ym_map, raw } = map;

	const dbp2fullp: Record<string, string[]> = {};
	function add_pinyin(dbp: string, fullp: string) {
		if (!dbp2fullp[dbp]) dbp2fullp[dbp] = [];
		if (!dbp2fullp[dbp].includes(fullp)) {
			dbp2fullp[dbp].push(fullp);
		}
	}

	for (const i of pinyin_k_l) {
		const r = getValue(raw, i);
		if (r) {
			add_pinyin(r, i);
			continue;
		}
		const [s, y] = spilt_pinyin(i);
		const ds = getValue(sm_map, s) ?? s;
		const dy = getValue(ym_map, y) ?? y;
		if ((ds + dy).length !== 2) continue;
		add_pinyin(ds + dy, i);
	}
	cache.set(map, dbp2fullp);
	return dbp2fullp;
}
